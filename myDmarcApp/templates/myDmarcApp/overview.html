{% extends 'myDmarcApp/base.html' %}


{% block title %} MyDmarc - Overview {% endblock %}
{% block content %}
{% load my_filters %}

<div class="col-sm-12 col-md-12 main">
<script type="text/javascript">
    var appendPies = function(data, targetSelector) {

        ["dkim", "spf", "disposition"].forEach(function(type){

                var width = 200,
                    height = 200,
                    radius = Math.min(width, height) / 2;

                var color;
                if (type == "disposition"){
                color = d3.scale.ordinal()
                    .domain(["reject", "quarantine", "pass"])
                    .range(["#FF0000", "#FFFF00", "#00FF00"]);
                } else {
                color = d3.scale.ordinal()
                    .domain(["fail", "pass"])
                    .range(["#FF0000", "#00FF00"]);
                }

                var arc = d3.svg.arc()
                    .outerRadius(radius - 10)
                    .innerRadius(0);

                var pie = d3.layout.pie()
                    .sort(null)
                    .value(function(d) { return d.cnt; });

                var svg = d3.select(targetSelector).append("svg")
                    .attr("class", type)
                    .attr("width", width)
                    .attr("height", height)
                  .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

                var g = svg.selectAll(".arc")
                    .data(pie(data[type]))
                    .enter().append("g")
                    .attr("class", "arc");

                g.append("path")
                   .attr("d", arc)
                   .style("fill", function(d) { return color(d.data.label); });

                g.append("text")
                    .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                    .attr("dy", ".35em")
                    .style("text-anchor", "middle")
                    .text(function(d) {return d.data.label; });
                
                var lineLegendOptions = {
                    legendItems : data[type].map(function(d){return {color: color(d.label), name: (d.cnt + " " + d.label)} })
                }
                g.append("g")
                  .attr("class", "legend")
                  .attr("transform", "translate(-80, -80)")
                  .style("font-size", "12px")
                  .call(d3.legend, lineLegendOptions); 
            });
    }
</script>

<h1>Overview</h1>
<div id="incoming">
    <h2>Incoming reports</h2>
    {% if incoming.oldest_date %}

    based on incoming reports from <strong>{{ incoming.oldest_date | date:"Y/n/j" }}</strong> to <strong>{% now "Y/n/j" %}</strong>
    <table>
    <tr><td>My domains count</td><td>{{incoming.data.domain_cnt}}</td></tr>
    <tr><td>Report count</td><td>{{incoming.data.report_cnt}}</td></tr>
    <tr><td>Message count</td><td>{{incoming.data.message_cnt}}</td></tr>
    </table>
    <div class="charts-container"></div>
    <script type="text/javascript">
        var incomingData = {{ incoming.data | to_json }};
        appendPies(incomingData, "#incoming .charts-container");
    </script>
    {% else %}
    No incoming reports so far. Start by ...
    {% endif %}
</div>
<div id="outgoing">
    <h2>Outgoing reports</h2>
    {% if outgoing.oldest_date %}
    based on outgoing reports from <strong>{{ outgoing.oldest_date | date:"Y/n/j" }}</strong> to <strong>{% now "Y/n/j" %}</strong>
    <table>
    <tr><td>Foreign domains count</td><td>{{outgoing.data.domain_cnt}}</td></tr>
    <tr><td>Report count</td><td>{{outgoing.data.report_cnt}}</td></tr>
    <tr><td>Message count</td><td>{{outgoing.data.message_cnt}}</td></tr>
    </table>
    <div class="charts-container"></div>
    <script type="text/javascript">
        var outgoingData = {{ outgoing.data | to_json }};
        appendPies(outgoingData, "#outgoing .charts-container");
    </script>
    {% else %}
    No outgoing reports so far. Start by ...
    {% endif %}
</div>

{% endblock %}