{% extends 'myDmarcApp/base.html' %}
{% load bootstrap3 %}
{% load staticfiles %}
{% load my_filters %}
{% load my_tags %}


{% block title %}MyDmarc - Deep Analysis{% endblock %}
{% block site_id %}deep-analysis{% endblock %}

{% block content %}

<div class="col-sm-3 col-md-2 sidebar">
    <ul class="nav nav-sidebar">
    {% for view in sidebar_views %}
        <li {% if view.id == the_view.id %}class="active"{% endif %}><a href="/deep-analysis/{{view.id}}/">{{view.title}}</a></li>
    {% endfor %}
    </ul>
</div>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h1 class="page-header">Deep Analysis</h1>
    <div class="bootstrap-messages-container">
        {% bootstrap_messages %}
    </div>
    <h2>{{the_view.title}}</h2>
    <p>{{the_view.description}}</p>

    <div class="panel-group" id="view-filter-details" role="tablist" aria-multiselectable="true">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab">
                <h4 class="panel-title">
                    Filtering from {% with date=the_view.daterange_set.first.getBeginEnd %} <strong>{{date.0 | date:"Y/n/j"}}</strong> to <strong>{{date.1 | date:"Y/n/j"}}</strong> {% endwith %}
                    on <strong>'{{ the_view.reporttype_set.first.get_value_display }}'</strong> reports
                    <a role="button" data-toggle="collapse" data-parent="#view-filter-details" href="#collapse-filterset-details" aria-expanded="false"> (click for details)
                </h4>
                
                </a>
            </div>
            <div id="collapse-filterset-details" class="panel-collapse collapse" role="tabpanel">
            <div class="panel-body">
                {% for fs in the_view.filterset_set.all %}
                <div>

                    <h5>
                        <span class="circle" style="background-color:{{fs.color}}"></span><span>Filter Set '{{fs.label}}'</span>
                    </h5>
                    <p>{% join_filter_set_field_values fs.reportsender_set.all "Report Sender Email" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.reportreceiverdomain_set.all "Report Receiver Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.sourceip_set.all "Mail Sender Source IP" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.aligneddkimresult_set.all "Aligned DKIM Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.alignedspfresult.all "Aligend SPF Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.disposition_set.all "Disposition" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.rawdkimdomain_set.all "Raw DKIM Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawdkimresult_set.all "Raw DKIM Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.multipledkim_set.all "Multiple DKIM Only" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawspfdomain_set.all "Raw SPF Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawspfresult_set.all  "Raw SPF Result" " or " True %}</p>
                </div>
                {% endfor %}
            </div>
            </div>
        </div>
    </div>

    {% if the_view.type_map %}
    <div class="description">
        You can switch between defined data sets by using the buttons above the map. Messages are associated with countries by using geoIp. Not all ip addresses are necessarily resolved.
    </div>
    <div class="view-type-map view-type" style="width:100%">
        <div class="btn-group switch-filterset"></div>
        <div class="svg-container" style="position:relative"></div>
        <div class="export-svg"> 
            <a onClick="analysis.export.svg({{the_view.id}}, 'map', this)" class="btn btn-important" role="button" href="#">Export map as PDF</a>
        </div>
    </div>
    <script type="text/javascript">
    $(document).ready(function(){
        analysis.map.init({{the_view.id}});
    })
    </script>
    {% endif %}
    {% if the_view.type_line %}
    <div class="description">
        Use the time lines mini map to zoom on the time axis.
    </div>
    <div class="view-type-linechart view-type" style="width: 100%">
        <div class="svg-container"></div>
        <div class="export-svg"> 
            <a onClick="analysis.export.svg({{the_view.id}}, 'line-chart', this)" href="#" class="btn btn-important" role="button">Export line chart as PDF</a>
        </div>
    </div>
    <script type="text/javascript">
    $(document).ready(function(){
        analysis.line.init({{the_view.id}});
    })
    </script>
    {% endif %}


    {% if the_view.type_table %}
    <div id="time-quick-filter">
        <div class="description">
            By selecting a date range in the the line chart only records within the range a shown in the table.
            {% if not the_view.type_line %}
                Of course you have to enable the line chart in the <a href="/edit-view/{{the_view.id}}/">view editor</a>.
            {% endif %}
         </div>
        <span id="time-quick-filter-date"></span>
    </div>
    <div class="view-type-table view-type">
        <table class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Reporter</th>
                    <th>Sender</th>
                    <th>IP</th>
                    <th>Country</th>
                    <th>Begin</th>
                    <th>End</th>
                    <th>Msg#</th>
                    <th data-orderable="false">DKIM Domains</th>
                    <th data-orderable="false">DKIM Results</th>
                    <th>aDKIM</th>
                    <th data-orderable="false">SPF Domains</th>
                    <th data-orderable="false">SPF Results</th>
                    <th>aSPF</th>
                    <th>Disposition</th>
                    <th>ReportId</th>
                    {% comment %}
                    <th>Label</th>
                    {% endcomment %}

                </tr>
            </thead>
        </table>
        <div class="export-csv"> 
            <a onClick="analysis.export.csv({{the_view.id}})" class="btn btn-important" role="button" href="#">Export Table as CSV</a>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function(){
            analysis.table.init({{the_view.id}});
        });
    </script>
    {% endif %}
    <a class="btn btn-important" role="button" href="/edit-view/{{the_view.id}}/">Edit View</a>
</div>
{% endblock %}