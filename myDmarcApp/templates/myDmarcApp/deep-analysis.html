{% extends 'myDmarcApp/base.html' %}

{% block title %}MyDmarc - Deep Analysis{% endblock %}

{% block content %}
<div class="col-sm-3 col-md-2 sidebar">
    <ul class="nav nav-sidebar">
    {% for view in sidebar_views %}
        <li {% if view.id == the_view.id %}class="active"{% endif %}><a href="/deep-analysis/{{view.id}}/">{{view.title}}</a></li>
    {% endfor %}
    </ul>
</div>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h1>Deep Analysis</h1>
    <h2>{{the_view.title}}</h2>
    <p>{{the_view.description}}</p>
    <div class="view-filter-details">
        <p>View Filter Details</p>
        {% with the_view.viewfilterfield_set.all|first as timefilter %}
            {{timefilter}}
        {% endwith %}
        {% for fs in the_view.filterset_set.all %}
            {{fs.label}}:
            {% for f in fs.filtersetfilterfield_set.all%}
                {{f.report_field}}: {{f.value}}
            {% endfor %}

        {% endfor %}
    </div>
    <div class="view-type-linechart">
        <canvas width="200" height="100"></canvas>
    </div>
    <script type="text/javascript">
        /*
         * Initialize Line Chart
         */
        
        $(document).ready(function(){
            var ctx = $(".view-type-linechart > canvas").get(0).getContext("2d");
            var data = {{ view_type_line_data | safe }};
            var lineChart = new Chart(ctx).Line(data, {
                responsive: true,
                datasetFill : false
            });
        });
    </script>

    <div class="view-type-table">
        <table class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Reporter</th>
                    <th>Mail sender</th>
                    <th>IP</th>
                    <th>Country</th>
                    <th>Report Time</th>
                    <th>Message #</th>
                    <th>DKIM Domains</th>
                    <th>DKIM Results</th>
                    <th>aligned DKIM</th>
                    <th>SPF Domains</th>
                    <th>SPF Results</th>
                    <th>aligned SPF</th>
                    <th>Disposition</th>
                </tr>
            </thead>

            {% for filter_set_data in view_type_table_data  %}
                {% for report in filter_set_data.reports %}
                    {% for record in report.record_set.all %}
                        <tr style="background-color:{{filter_set_data.filter_set.color}}">
                            <td>{{report.reporter.org_name}}</td>
                            <td>{{report.domain}}</td>
                            <td>{{record.source_ip}}</td>
                            <td>{{record.country_iso_code}}</td>
                            {% comment %}
                            XXX LP: Only display borth dates if it ranges over multiple days
                            <td>{{report.date_range_begin | date:"Y/n/j"}} {{report.date_range_end | date:"Y/n/j"}}</td>
                            {% endcomment %}
                            <td>{{report.date_range_begin | date:"Y/n/j"}} </td>

                            <td>{{record.count}}</td>
                            {% comment %}
                                XXX LP: Think of ordering in nested table cells!!!
                            {% endcomment %}
                            <td>
                                {% for dkim in record.authresultdkim_set.all%}
                                    {{dkim.domain}}
                                {% endfor %}
                            </td>
                            <td>
                                {% for dkim in record.authresultdkim_set.all%}
                                    {{dkim.get_result_display}}
                                {% endfor %}
                            </td>
                            <td>{{record.get_dkim_display}}</td>
                            <td>
                                {% for spf in record.authresultspf_set.all%}
                                    {{spf.domain}}
                                {% endfor %}
                            </td>
                            <td>
                                {% for spf in record.authresultspf_set.all%}
                                    {{spf.get_result_display}}
                                {% endfor %}
                            </td>
                            <td>{{record.get_spf_display}}</td>
                            <td>{{record.get_disposition_display}}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </table>
    </div>
    <a class="btn btn-info" role="button" href="/edit-view/{{the_view.id}}/">Edit</a>

    <script type="text/javascript">
        /*
         * Initialize DataTable 
         */
        $(document).ready(function(){
            $('.view-type-table table').DataTable({
                paging: true,
            });
        });
    </script>
</div>
{% endblock %}