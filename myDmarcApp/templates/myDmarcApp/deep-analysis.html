{% extends 'myDmarcApp/base.html' %}

{% block title %}MyDmarc - Deep Analysis{% endblock %}
{% block site_id %}deep-analysis{% endblock %}

{% block content %}
{% load staticfiles %}
{% load my_filters %}
{% load my_tags %}

<div class="col-sm-3 col-md-2 sidebar">
    <ul class="nav nav-sidebar">
    {% for view in sidebar_views %}
        <li {% if view.id == the_view.id %}class="active"{% endif %}><a href="/deep-analysis/{{view.id}}/">{{view.title}}</a></li>
    {% endfor %}
    </ul>
</div>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    {% comment %}
    <h1 class="page-header">Deep Analysis</h1>
    {% endcomment %}

    <h2>{{the_view.title}}</h2>
    <p>{{the_view.description}}</p>

    <div class="panel-group" id="view-filter-details" role="tablist" aria-multiselectable="true">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab">
                <h4 class="panel-title">
                    Filtering from {% with date=the_view.daterange_set.first.getBeginEnd %} <strong>{{date.0 | date:"Y/n/j"}}</strong> to <strong>{{date.1 | date:"Y/n/j"}}</strong> {% endwith %}
                    on <strong>'{{ the_view.reporttype_set.first.get_value_display }}'</strong> reports
                    <a role="button" data-toggle="collapse" data-parent="#view-filter-details" href="#collapse-filterset-details" aria-expanded="false"> (click for details)
                </h4>
                
                </a>
            </div>
            <div id="collapse-filterset-details" class="panel-collapse collapse" role="tabpanel">
            <div class="panel-body">
                {% for fs in the_view.filterset_set.all %}
                <div>

                    <h5>
                        <span class="circle" style="background-color:{{fs.color}}"></span><span>Filter Set '{{fs.label}}'</span>
                    </h5>
                    <p>{% join_filter_set_field_values fs.reportsender_set.all "Report Sender Email" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.reportreceiverdomain_set.all "Report Receiver Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.sourceip_set.all "Mail Sender Source IP" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.aligneddkimresult_set.all "Aligned DKIM Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.alignedspfresult.all "Aligend SPF Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.disposition_set.all "Disposition" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.rawdkimdomain_set.all "Raw DKIM Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawdkimresult_set.all "Raw DKIM Result" " or " True %}</p>
                    <p>{% join_filter_set_field_values fs.multipledkim_set.all "Multiple DKIM Only" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawspfdomain_set.all "Raw SPF Domain" " or " %}</p>
                    <p>{% join_filter_set_field_values fs.rawspfresult_set.all  "Raw SPF Result" " or " True %}</p>
                </div>
                {% endfor %}
            </div>
            </div>
        </div>
    </div>

    {% if the_view.type_map %}
    <div class="view-type-map view-type" style="width:100%">
        <div class="btn-group switch-filterset"></div>
        <div class="svg-container" style="position:relative"></div>
        <div class="export-svg"> 
            <a class="btn btn-important" role="button" href="#">Export Map as PDF</a>
        </div>
    </div>
    <script type="text/javascript">
    $(document).ready(function(){
        analysis.map.init({{ view_type_map_data | to_json }});
        
        // Update the map and legend with data on button click
        $(".view-type-map .btn-group button").on('click', function(e){
            analysis.map.update(this);
        });
        // Trigger first button to be clicked
        $(".view-type-map .btn-group button:first-child").click();
    })
    </script>
    {% endif %}
    {% if the_view.type_line %}
    <div class="view-type-linechart view-type" style="width: 100%">
        <div class="svg-container"></div>
        <div class="export-svg"> 
            <a href="#" class="btn btn-important" role="button">Export Chart as PDF</a>
        </div>
    </div>
    <script type="text/javascript">
    $(document).ready(function(){
        analysis.line.init({{ view_type_line_data | to_json }});
    })
    </script>
    {% endif %}


    {% if the_view.type_table %}
    <div id="time-quick-filter">
        <span class="description">
            Filter table records by selecting a time range in the line chart minimap.
            {% if not the_view.type_line %}
                Of course you have to enable the line chart in the <a href="/edit-view/{{the_view.id}}/">view editor</a>.
            {% endif %}
         </span><br>
        <span id="time-quick-filter-date"></span>
    </div>
    <div class="view-type-table">
        <table class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Reporter</th>
                    <th>Sender</th>
                    <th>IP</th>
                    <th>Country</th>
                    <th>Begin</th>
                    <th>End</th>
                    <th>Msg#</th>
                    <th data-orderable="false">DKIM Domains</th>
                    <th data-orderable="false">DKIM Results</th>
                    <th>aDKIM</th>
                    <th data-orderable="false">SPF Domains</th>
                    <th data-orderable="false">SPF Results</th>
                    <th>aSPF</th>
                    <th>Disposition</th>
                    <th>ReportId</th>
                    {% comment %}
                    <th>Label</th>
                    {% endcomment %}

                </tr>
            </thead>
        </table>
        <div class="export-csv"> 
            <a class="btn btn-important" role="button" href="#">Export Table as CSV</a>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function(){
            analysis.table.init({{the_view.id}});
        });
    </script>
    {% endif %}
    <div class="clearfix"></div>
    <a class="btn btn-important" role="button" href="/edit-view/{{the_view.id}}/">Edit View</a>
        
    <script type="text/javascript">
        /*
         * Exporting SVG and CSV
         */
        $(document).ready(function(){
            $(".export-svg .btn").on("click", function(){
                var svg_node = $(this).closest(".view-type").find(".svg-container svg").get(0)

                $('<form>', {
                    'action': "/export-svg/{{the_view.id}}/",
                    'target': "_blank",
                    'method': "POST"
                }).append($('<textarea>', {
                    'name': "svg",
                    'value': (new XMLSerializer).serializeToString(svg_node),
                })).append("{% csrf_token %}").submit();
                // One should know that input field text is limited to 512KB length
            });
            $(".export-csv .btn").on("click", function(){
                $('<form>', {
                    'action': "/export-csv/{{the_view.id}}/",
                    'target': "_blank",
                    'method': "POST"
                }).append("{% csrf_token %}").submit();     
            });
        })
    </script>

</div>
{% endblock %}