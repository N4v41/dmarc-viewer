{% extends 'myDmarcApp/base.html' %}

{% block title %}MyDmarc - Deep Analysis{% endblock %}

{% block content %}
{% load staticfiles %}
{% load my_filters %}
<div class="col-sm-3 col-md-2 sidebar">
    <ul class="nav nav-sidebar">
    {% for view in sidebar_views %}
        <li {% if view.id == the_view.id %}class="active"{% endif %}><a href="/deep-analysis/{{view.id}}/">{{view.title}}</a></li>
    {% endfor %}
    </ul>
</div>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h1>Deep Analysis</h1>
    <h2>{{the_view.title}}</h2>
    <p>{{the_view.description}}</p>

    {% comment %}
        
    <div class="view-filter-details">
        <p>View Filter Details</p>
        {% with the_view.viewfilterfield_set.all|first as timefilter %}
            {{timefilter}}
        {% endwith %}
        {% for fs in the_view.filterset_set.all %}
            {{fs.label}}:
            {% for f in fs.filtersetfilterfield_set.all%}
                {{f.report_field}}: {{f.value}}
            {% endfor %}

        {% endfor %}
    </div>
    {% endcomment %}

    <div class="view-type-linechart"></div>
    <script type="text/javascript">
        // Create margins, heights, widths for both plots
        var margin = {top: 40, right: 10, bottom: 100, left: 40},
            marginMini = {top: 430, right: 10, bottom: 20, left: 40},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom,
            heightMini = 500 - marginMini.top - marginMini.bottom;

        // Create date format praser
        var parseDate = d3.time.format("%Y%m%d").parse;

        // Ranges for both plots
        var x = d3.time.scale().range([0, width]),
            y = d3.scale.linear().range([height, 0]),
            xMini = d3.time.scale().range([0, width]),
            yMini = d3.scale.linear().range([heightMini, 0]);

        //Axis for both plots
        var xAxis = d3.svg.axis().scale(x).orient("bottom"),
            yAxis = d3.svg.axis().scale(y).orient("left"),
            xAxisMini = d3.svg.axis().scale(xMini).orient("bottom");

        var xGridLines = d3.svg.axis().scale(x).orient("bottom").tickSize(-height, 0, 0).tickFormat(""),
            yGridLines = d3.svg.axis().scale(y).orient("left").tickSize(-width, 0, 0).tickFormat("");

        //Moving a brush in mini chart changes chart domain
        var brush = d3.svg.brush()
            .x(xMini)
            .on("brush", function() { 
              x.domain(brush.empty() ? xMini.domain() : brush.extent());
              focus.selectAll(".line").attr("d", line);
              focus.select(".x.axis").call(xAxis);
              focus.select(".x.grid").call(xGridLines);
            });

        //Append svg to document
        var svg = d3.select(".view-type-linechart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        //Define a viewport, so that the line does not move over axis
        svg.append("defs").append("clipPath")
            .attr("id", "clip")
          .append("rect")
            .attr("width", width)
            .attr("height", height);

        // Append main chart to svg and place it
        var focus = svg.append("g")
            .attr("class", "focus")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Append overview chart to svg and place it 
        var context = svg.append("g")
            .attr("class", "context")
            .attr("transform", "translate(" + marginMini.left + "," + marginMini.top + ")");

        // Create main chart line generator
        var line = d3.svg.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.cnt); });

        // Create overview chart line generator
        var lineMini = d3.svg.line()
            .x(function(d) { return xMini(d.date); })
            .y(function(d) { return yMini(d.cnt); });

        // Get the data
        // XXX LP Maybe get this with ajax
        var lineData = {{ view_type_line_data | to_json }};
        var dataSets = lineData.data_sets;
        var begin    = parseDate(lineData.begin);
        var end      = parseDate(lineData.end);

        // Convert date strings to dates
        dataSets.forEach(function(dataSet){
          dataSet.data.forEach(function(obj){
            obj.date = parseDate(obj.date);
          })
        })

        //Create 0 data points for days of range that are not in the dataset
        //data MUST be orderd by date
        var days = d3.time.day.range(begin, end);
        dataSets.forEach(function(dataSet){
            data_len = dataSet.data.length;
            data_tmp = [];
            var j = 0;
            for (var i = 0; i < days.length; i++) {
                // + for number cast
                if ((data_len > j) && (+days[i] == +dataSet.data[j].date)){
                    cnt = dataSet.data[j].cnt; 
                    j += 1;
                } else {
                    cnt = 0;
                }
                data_tmp.push({date: days[i], cnt: cnt});
            }
            dataSet.data = data_tmp
        });

        // Get min and max date by traversing all datasets' data lists
        
        x.domain([begin, end]);

        // Get max value by traversing all datasets' data lists
        y.domain(
          [0, d3.max([].concat.apply([], 
            dataSets.map(function(dataSet){return dataSet.data.map(
              function(d){return d.cnt; })})))]);

        // Get the domains for x and y values for overview chart
        xMini.domain(x.domain());
        yMini.domain(y.domain());

        // Create the actual lines and append to svg
        dataSets.forEach(function(dataSet, idx) {
          // for main chart
          focus.append("path")
              .datum(dataSet.data)
              .attr("class", "line")
              .attr("d", line)
              .attr('stroke', dataSet.color);
          // and for mini chart
          context.append("path")
              .datum(dataSet.data)
              .attr("class", "line")
              .attr("d", lineMini)
              .attr('stroke', dataSet.color);
        });

        // Append X Axis for main chart
        focus.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        // Append Y Axis for main chart
        focus.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        // prepend gridlines, so they are under the lines 
        focus.insert("g", ":first-child")
            .attr("class", "x grid")
            .attr("transform", "translate(0," + height + ")")
            .call(xGridLines);
        focus.insert("g", ":first-child")
            .attr("class", "y grid")
            .call(yGridLines);

        svg.append("text")
            .attr("transform", "translate(" + (width / 2) + " ," + margin.top / 2 + ")")
            .attr("class", "x label")
            .style("text-anchor", "middle")
            .text("Time");

        svg.append("text")
            .attr("class", "y label")
            .attr("transform", "rotate(-90)")
            .attr("y", margin.left / 2)
            .attr("x", 0 - (height / 2))
            .style("text-anchor", "middle")
            .text("Message Count");

        // Append X Axis for mini chart
        context.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + heightMini + ")")
            .call(xAxisMini);

        // Append the moving window for the mini chart
        context.append("g")
            .attr("class", "x brush")
            .call(brush)
          .selectAll("rect")
            .attr("y", -6)
            .attr("height", heightMini + 7);

        // Create a legend
        var legendItemRectSize = 18,
            legendSpacing = 4;
            
        var legend = svg.append('g')
            .attr('transform', 
                'translate(' + (margin.left + 10) + ',' + (margin.top + 10) + ')')
            .attr('class', 'legend')

        var legendItem = legend.selectAll('.legend-item')
          .data(dataSets)
          .enter()
          .append('g')
          .attr('class', 'legend-item')
          .attr('transform', function(d, i) {
            var itemHeight = legendItemRectSize + legendSpacing;
            var horz = legendSpacing;
            var vert = legendSpacing + i * itemHeight;
            return 'translate(' + horz + ',' + vert + ')';
          });

        legendItem.append('rect')
          .attr('width', legendItemRectSize)
          .attr('height', legendItemRectSize)
          .style('fill', function(d){return d.color})
          .style('stroke', function(d){return d.color});

        legendItem.append('text')
          .attr('x', legendItemRectSize + legendSpacing)
          .attr('y', legendItemRectSize - legendSpacing)
          .text(function(dataSet) { return dataSet.label; });

        legendBBox = $('.legend')[0].getBBox();
        legend.insert('rect', ':first-child')
            .attr('class', 'legend-box')
            .attr('width', legendBBox.width + 2 * legendSpacing)
            .attr('height', legendBBox.height + 2 * legendSpacing)
            .style('fill', 'white')
            .style('stroke', 'black');

    </script>


    <div class="view-type-table">
        <table class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Reporter</th>
                    <th>Mail sender</th>
                    <th>IP</th>
                    <th>Country</th>
                    <th>Report Time</th>
                    <th>Message #</th>
                    <th>DKIM Domains</th>
                    <th>DKIM Results</th>
                    <th>aligned DKIM</th>
                    <th>SPF Domains</th>
                    <th>SPF Results</th>
                    <th>aligned SPF</th>
                    <th>Disposition</th>
                    <th>Label</th>
                </tr>
            </thead>

            {% for filter_set_data in view_type_table_data  %}
                {% for record in filter_set_data.records %}
                    <tr style="background-color:{{filter_set_data.filter_set.color}}">
                        <td>{{record.report.reporter.org_name}}</td>
                        <td>{{record.report.domain}}</td>
                        <td>{{record.source_ip}}</td>
                        <td>{{record.country_iso_code}}</td>
                        {% comment %}
                        XXX LP: Only display borth dates if it ranges over multiple days
                        <td>{{report.date_range_begin | date:"Y/n/j"}} {{report.date_range_end | date:"Y/n/j"}}</td>
                        {% endcomment %}
                        <td>{{record.report.date_range_begin | date:"Y/n/j"}} </td>

                        <td>{{record.count}}</td>
                        {% comment %}
                            XXX LP: Think of ordering in nested table cells!!!
                        {% endcomment %}
                        <td>
                            {% for dkim in record.authresultdkim_set.all%}
                                {{dkim.domain}}
                            {% endfor %}
                        </td>
                        <td>
                            {% for dkim in record.authresultdkim_set.all%}
                                {{dkim.get_result_display}}
                            {% endfor %}
                        </td>
                        <td>{{record.get_dkim_display}}</td>
                        <td>
                            {% for spf in record.authresultspf_set.all%}
                                {{spf.domain}}
                            {% endfor %}
                        </td>
                        <td>
                            {% for spf in record.authresultspf_set.all%}
                                {{spf.get_result_display}}
                            {% endfor %}
                        </td>
                        <td>{{record.get_spf_display}}</td>
                        <td>{{record.get_disposition_display}}</td>
                        <td>{{filter_set_data.filter_set.label}}</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>
    </div>
    <a class="btn btn-info" role="button" href="/edit-view/{{the_view.id}}/">Edit</a>

    <script type="text/javascript">
        /*
         * Initialize DataTable 
         */
        $(document).ready(function(){
            $('.view-type-table table').DataTable({
                paging: true,
            });
        });
    </script>
</div>
{% endblock %}